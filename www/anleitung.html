<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>Unbenanntes Dokument</title>
</head>

<body style="font-family: 'Lucida Grande', 'Lucida Sans Unicode', 'Lucida Sans', 'DejaVu Sans', Verdana, sans-serif; font-size: 12px;">
<a name="#top">Inhalt:</a><br><br>
<a href="#1">1. Account Einstellungen</a><br>
<a href="#2">2. Vorlagen Einstellungen</a><br>
<a href="#3">3. Das Skript zum versenden der Mail</a><br>
<a href="#4">4. Was ist TCL?</a><br>
<a href="#5">5. Umlaute richtig anzeigen</a><br>
<a href="#6">6. Mails mittels CUxD Gerätetyp 91 versenden</a><br>
<a href="#7">7. Fehlermeldungen der Logfiles.</a><br>
<a href="#8">8. Wieso kann ich keine Mails versenden?</a>
  <br>
  <br>
  <br>
  <br>
  <strong><a name="1">1. Account Einstellungen:</a></strong><br><br>
Unter dem Reiter "Account" wird der Email-Account zum Versenden der Mail eingestellt. Hierzu wird der SMTP-Server, der Absender (Mailadresse des Kontos), der Benutzername (häufig die Email-Adresse) und das Passwort benötigt. Des Weiteren muss die Authentifikation (meist Login oder Plain), der Port und ob eine Verschlüsselte Verbindung verwendet wird eingestellt werden. Zudem kann es bei der Verwendung von Port 465 (SSL/TLS) erforderlich sein STARTTLS zu deaktivieren.
<br><br>
Beispiel Konfigurationen:</p>
<table width="450" border="0">
  <tbody>
    <tr>
      <td width="123" bgcolor="#F4DA7F">SMTP Server</td>
      <td width="54" bgcolor="#F4DA7F" style="text-align: center"><p>Authenti-fikation</p></td>
      <td width="36" bgcolor="#F4DA7F" style="text-align: center">Port</td>
      <td width="40" bgcolor="#F4DA7F" style="text-align: center">TLS</td>
      <td width="62" bgcolor="#F4DA7F" style="text-align: center">STARTTLS deaktiviert</td>
      <td width="109" bgcolor="#F4DA7F" style="text-align: center">Besonderheit</td>
    </tr>
    <tr>
      <td bgcolor="#BCBCBC">smtp.smart-mail.de</td>
      <td bgcolor="#BCBCBC" style="text-align: center">Login</td>
      <td bgcolor="#BCBCBC" style="text-align: center">25</td>
      <td bgcolor="#BCBCBC" style="text-align: center">nein</td>
      <td bgcolor="#BCBCBC" style="text-align: center">nein</td>
      <td bgcolor="#BCBCBC" style="text-align: center">nein</td>
    </tr>
    <tr>
      <td>mail.gmx.net </td>
      <td style="text-align: center">Login</td>
      <td style="text-align: center">587</td>
      <td style="text-align: center">ja</td>
      <td style="text-align: center">nein</td>
      <td style="text-align: center">nein</td>
    </tr>
    <tr>
      <td bgcolor="#BCBCBC">smtp.web.de</td>
      <td bgcolor="#BCBCBC" style="text-align: center">Login</td>
      <td bgcolor="#BCBCBC" style="text-align: center">587</td>
      <td bgcolor="#BCBCBC" style="text-align: center">ja</td>
      <td bgcolor="#BCBCBC" style="text-align: center">nein</td>
      <td bgcolor="#BCBCBC" style="text-align: center">nein</td>
    </tr>
    <tr>
      <td>smtp.mail.yahoo.com</td>
      <td style="text-align: center">Login</td>
      <td style="text-align: center">587</td>
      <td style="text-align: center">ja</td>
      <td style="text-align: center">nein</td>
      <td style="text-align: center">nein</td>
    </tr>
    <tr>
      <td bgcolor="#BCBCBC">smtp.gmail.com</td>
      <td bgcolor="#BCBCBC" style="text-align: center">Login</td>
      <td bgcolor="#BCBCBC" style="text-align: center">587</td>
      <td bgcolor="#BCBCBC" style="text-align: center">ja</td>
      <td bgcolor="#BCBCBC" style="text-align: center">nein</td>
      <td bgcolor="#BCBCBC" style="text-align: center">nein</td>
    </tr>
    <tr>
      <td>smtp.ewe.net</td>
      <td style="text-align: center">Login</td>
      <td style="text-align: center">587</td>
      <td style="text-align: center">ja</td>
      <td style="text-align: center">nein</td>
      <td style="text-align: center">Absender & Benutzername = Mailadresse</td>
    </tr>
    <tr>
      <td bgcolor="#BCBCBC">Alfahosting</td>
      <td bgcolor="#BCBCBC" style="text-align: center">Login</td>
      <td bgcolor="#BCBCBC" style="text-align: center">465</td>
      <td bgcolor="#BCBCBC" style="text-align: center">ja</td>
      <td bgcolor="#BCBCBC" style="text-align: center">ja</td>
      <td bgcolor="#BCBCBC" style="text-align: center">nein</td>
    </tr>
  </tbody>
</table>
<br>
<br>
<strong><a name="2">2. Vorlagen Einstellungen:</a></strong><br><br>
Unter dem Reiter "E-Mails" können 50 Mail-Vorlagen definiert werden. In der Zeile "An" wird die Mail-Adresse des Empfängers und unter "Betreff" der Betreff der Mail eingetragen. In das große Eingabefeld wird der eigentliche Email Text eingetragen, hier können auch zuvor unter "TCL" definierte Variablen bzw. Platzhalter mittels einem vorangestellten Dollar-Zeichen ($) eingebunden werden. Sofern Variablen/Platzhalter verwendet werden sollen, muss unten der Haken für "Tcl aktivieren" gesetzt werden. Siehe auch Punkt 4 „Was ist TCL?“<br><br>
<strong><a name="3">3. Das Skript zum Versenden der Mail:</a></strong><br>
<br>
Die folgenden drei Code-Zeilen werden in das Zentralen-Programm unter "Aktivität: Dann..." > "Skript" eingefügt. Damit eine Email versendet werden kann, muss unter "Bedingung: Wenn..." ein auslösendes (triggerndes) Ereignis definiert werden. Zum Beispiel: Wenn... "Geräteauswahl" Türkontakt bei "offen" "bei Änderung auslösen"
Die <span style="color: #D50003">ID</span> aus der dritten Code-Zeile muss durch die Nummer der entsprechenden Mail-Vorlage ersetzt werden (01-50). <br>
<br>
<span style="color: #34A028"><em>string stdout;<br>
string stderr;<br>
system.Exec("/etc/config/addons/email/email <span style="color: #D50003"><strong>ID</strong></span>", &amp;stdout, &amp;stderr);</em></span><br>
<br>
<strong><a name="4">4. Was ist TCL?</a></strong><br><br>
TCL ist ein mächtiges Werkzeug, welches die Möglichkeit bietet Platzhalter für eine Mail-Vorlage zu definieren, aber auch das Auslesen von CCU Variablen oder Zuständen ist hiermit einfach möglich. Ein erstelltes TCL-Skript wird vor dem Versand einer E-Mail ausgeführt, sofern die Tcl-Option in der Mail-Vorlage aktiviert ist. Folgend ein Beispiel TCL-Skript, welches die Temperatur und Luftfeuchte eines HomeMatic Sensors ausließt und in die Variablen (v1 und v2) schreibt. In der Mail-Vorlage werden die Variablen (v1 und v2) dann mit vorangestellten Dollar-Zeichen ($v1 und $v2) in den Emailtext oder auch der Betreff-Zeile eingefügt. Die Seriennummer im TCL-Skript muss durch die <span style="color: #D50003"><strong>Seriennummer</strong></span> eurer HomeMatic Komponente ersetzt werden. Weiter Informationen zu HomeMatic Datenpunkten können dem <a href="http://www.eq-3.de/Downloads/Software/HM-CCU2-Firmware_Updates/Tutorials/hm_devices_Endkunden.pdf" target="_blank">eQ-3 HomeMatic Script Teil 4</a> entnommen werden. <br>
<br>

Beispiel, Temperatur & Luftfeuchte:<br>
<span style="color: #34A028"><em>load tclrega.so<br>
<br>
array set values [rega_script {<br>
    var v1 = dom.GetObject("BidCos-RF.<span style="color: #D50003"><strong>FEQ0001234:1</strong></span>.TEMPERATURE").Value();<br>
    var v2 =  dom.GetObject("BidCos-RF.<span style="color: #D50003"><strong>FEQ0001234:1</strong></span>.HUMIDITY").Value();<br>
} ]<br>
<br>
set v1 $values(v1)<br>
set v2 $values(v2)</em></span><br>
<br>

Beispiel, Status eines Fensterkontakts auslesen:<br>
<span style="color: #34A028"><em>load tclrega.so<br>
<br>
array set values [rega_script {<br>
if<br> (dom.GetObject("BidCos-RF.<span style="color: #D50003"><strong>LEQ0187617:1</strong></span>.STATE").Value() == 'false') {<br>
   var v1 = "offen";<br>
}else {<br>
   var v1 = "geschlossen";<br>
}<br>
} ]<br>
<br>
set v1 $values(v1)</em></span><br>
<br>

Beispiel, Variable "Anwesenheit" auslesen:<br>
Damit bei einer ausgelesenen Variable nicht "true" bzw. "false" in der Email steht, können die Zustände wie folgt übersetzt werden.<br>
<span style="color: #34A028"><em>load tclrega.so<br>
<br>
array set values [rega_script {<br>
if<br> if (dom.GetObject("<span style="color: #D50003"><strong>Anwesenheit</strong></span>").Value() == 'false') {<br>
   var v1 = "Zuhause";<br>
}else {<br>
   var v1 = "nicht da!";<br>
}<br>
} ]<br>
<br>
set v1 $values(v1)</em></span><br>
<br>

<strong><a name="5">5. Umlaute richtig anzeigen:</a></strong><br><br>
Damit die Umlaute einer Variable korrekt in der Mail dargestellt werden, muss der Zeichensatz der Variable konvertiert werden. Dies kann mit der folgenden Zeile  umgesetzt werden.<br><br>
<span style="color: #34A028"><em>set test [encoding convertfrom utf-8 $values(test)]</em></span><br><br>
Beispiel, auslesen einer Variable (<span style="color: #D50003">test</span>, Typ: Zeichenkette):<br>
<span style="color: #34A028"><em>load tclrega.so<br>
<br>
array set values [rega_script {<br>
var v1 = dom.GetObject("<span style="color: #D50003"><strong>test</strong></span>").Value();<br>
} ]<br>
<br>
set v1 [encoding convertfrom utf-8 $values(v1)]</em></span><br>
<br>

<strong><a name="6">6. Mails mittels CUxD Gerätetyp 91 versenden:</a></strong><br><br>
Das CCU Addon <a href="http://homematic-forum.de/forum/viewtopic.php?f=37&t=15298" target="_blank">CUx-Daemon</a> ist bekannter weise in der Lage, neue "virtuelle" Geräte direkt in die CCU einzubinden. Mit dem CUxD Gerätetyp 91 (CloudMatic Mail) ist es ab Version  0.67 durch ändern des CMD_EXEC Parameters möglich die Mails direkt im Zentralen Programmen zu definieren ohne hierfür ein Skript zu verwenden. Hinweis: hierzu wird kein "meine-homematic/CloudMatic" Zugang benötigt. Die Account Einstellungen werden nach wie vor im Email-Addon vorgenommen.<br>
<br>
Vorgehensweise:<br>
1. Über CUxD ein neues Geräte (91 CloudMatic Mail) erstellen.<br>
2. In der WebUI unter > Einstellungen > Posteingang > das neue Gerät in die CCU übernehmen (auf Fertig klicken).<br>
3. In der WebUI unter > Einstellungen > Geräte > hinten zu diesem Gerät auf "Einstellen&quot; klicken.<br>
4. Die Zeile aus dem unteren Eingabefeld (SYSTEM|CMD_EXEC) durch folgende Zeile ersetzen:<br><br><span style="color: #34A028"><em>/etc/config/addons/email/email_cuxd</em></span><br><br>
5. CCU neustarten!<br><br>
Im Zentralen-Programm kann dann wie im folgenden Bild zusehen durch mehrfaches einfügen des CUxD-Email-Gerätes die Mail aufgebaut und abschließend mit dem Parameter SEND abgeschickt werden:<br>
<img src="img/cuxmail.png" width="450" height="99" alt=""/><br><br>
Mögliche Parameter:
<table width="450" border="0">
  <tbody>
    <tr>
      <td bgcolor="#BCBCBC">SEND</td>
      <td bgcolor="#BCBCBC">Tastendruck auf WebUI zum Versenden der Mail</td>
    </tr>
    <tr>
      <td>MAILTO</td>
      <td>Email-Empfänger</td>
    </tr>
    <tr>
      <td bgcolor="#BCBCBC">MAILCC</td>
      <td bgcolor="#BCBCBC">Kopie der Email an weiteren Empfänger</td>
    </tr>
    <tr>
      <td>SUBJECT</td>
      <td>Betreff  der Mail</td>
    </tr>
    <tr>
      <td bgcolor="#BCBCBC">TYPE=STANDARD</td>
      <td bgcolor="#BCBCBC">Email im Text-Format</td>
    </tr>
    <tr>
      <td>TYPE=HTML</td>
      <td>Email im HTML-Format</td>
    </tr>
    <tr>
      <td bgcolor="#BCBCBC">TEXT</td>
      <td bgcolor="#BCBCBC">Der Text der Email</td>
    </tr>
    <tr>
      <td>TEMPLATEID</td>
      <td>1-50, zur Verwendung der Email-Vorlagen aus dem Addon</td>
    </tr>
    <tr>
      <td bgcolor="#BCBCBC">OPTION_1 bis OPTION_5</td>
      <td bgcolor="#BCBCBC">für vordefiniertes Template, können in den Geräteeinstellungen definiert werden</td>
    </tr>

  </tbody>
</table>
<br>
<strong><a name="7">7. Fehlermeldungen der Logfiles.</a></strong><br>
<br>
Im Hilfe-Bereich  werden zwei verschiedene Logfiles angezeigt, diese werden alle 10 Sekunden automatisch aktualisiert. Je nach Fehler kann die Anzeige des Log-Eintrags mehrere Minuten dauern! Die "email.log" welche direkt vom Email-Addon erstellt wird, gibt Meldungen über erfolgreiches oder fehlerhaftes senden einer Email aus. Das zweite Logfile, die "CCU-Syslog", gibt Meldungen über ggf. fehlerhafte Nutzung des msmtp-Diensts aus.<br>
<br>
Mögliche Meldungen:<br>
<table width="450" border="0">
  <tbody>
      <tr>
<td bgcolor="#F4DA7F" style="text-align: center">Meldung email.log</td>
<td bgcolor="#F4DA7F" style="text-align: center">Meldung Syslog</td>
<td bgcolor="#F4DA7F" style="text-align: center">Fehlerbeschreibung</td>
    </tr>
    <tr>
      <td style="text-align: center">exitcode=EX_OK</td>
      <td style="text-align: center">kein Eintrag</td>
      <td style="text-align: center; color: #34A028;">Die Email wurde erfolgreich gesendet</td>
    </tr>
    <tr>
      <td bgcolor="#BCBCBC" style="text-align: center">Connection timed out' exitcode=EX_TEMPFAIL</td>
      <td bgcolor="#BCBCBC" style="text-align: center;">msmtp: cannot connect to <br>
        SMTP-SERVER, port XXX: <br>
        Connection timed out msmtp: <br>
      could not send mail</td>
      <td bgcolor="#BCBCBC" style="text-align: center; color: #D50003;">Zeitüberschreitung: falscher Port </td>
    </tr>
    <tr>
<td style="text-align: center">Error: authentication failed: <br>
  authentication failure' <br>
  errormsg='authentication failed <br>
  (method PLAIN)' exitcode=EX_NOPERM</td>
            <td style="text-align: center">msmtp: authentication <br>
            failed (method PLAIN)</td>
      <td style="text-align: center"><p style="color: #D50003;">Authentifikation fehlgeschlagen: Benutzername oder Kennwort falsch, bzw. falsche Authentifikations-Methode</p></td>
    </tr>
    <tr>
      <td bgcolor="#BCBCBC" style="text-align: center">errormsg='the server does <br>
        not support authentication method XXX' <br>
      exitcode=EX_UNAVAILABLE</td>
      <td bgcolor="#BCBCBC" style="text-align: center">msmtp: the server does <br>
        not support authentication <br>
      method XXX</td>
      <td bgcolor="#BCBCBC" style="text-align: center; color: #D50003;"><p>Ausgewählte <span style="color: #D50003;">Authentifikations-</span><span style="color: #D50003;">Methode</span> wird vom Server nicht unterstützt</p></td>
    </tr>
        <tr>
<td style="text-align: center">errormsg='cannot locate host <br>
  SMTP-SERVER.de: Name or service <br>
  not known' exitcode=EX_NOHOST</td>
          <td style="text-align: center">msmtp: cannot locate host <br>
            SMTP-SERVER.de: Name or <br>
          service not known</td>
      <td style="text-align: center; color: #D50003;">SMTP-Server Adresse ist falsch</td>
    </tr>
        <tr>
      <td bgcolor="#BCBCBC" style="text-align: center">errormsg='cannot connect to <br>
        SMTP-SERVER.de, port 587: Network <br>
        is unreachable' exitcode=EX_TEMPFAIL</td>
      <td bgcolor="#BCBCBC" style="text-align: center">msmtp: cannot connect to <br>
        SMTP-SERVER.de, port 587: <br>
        Network is unreachable</td>
      <td bgcolor="#BCBCBC" style="text-align: center; color: #D50003;"><p>Internetverbindung unterbrochen oder CCU-Netzwerkeinstellungen fehlerhaft: Gateway prüfen</p></td>
    </tr>
           <tr>
<td style="text-align: center">errormsg='envelope from address <br>
  TEST@TEST.de not accepted by <br>
  the server' exitcode=EX_DATAERR</td>
            <td style="text-align: center">msmtp: envelope from address <br>
              TEST@TEST.de not accepted <br>
             by the server</td>
      <td style="text-align: center; color: #D50003;"><p><span style="color: #D50003;">Authentifikation ausgeschaltet - versenden ohne </span><span style="color: #D50003;">Authentifikation</span> nicht möglich</p></td>
    </tr> 
  </tbody>
</table>
<br><br>
<strong><a name="8">8. Wieso kann ich keine Mails versenden?</a></strong><br><br>
Sofern trotz korrekter Account-Einstellungen keine Mails versandt werden können, liegt dies häufig an einer fehlerhaften Netzwerk-Konfiguration der CCU. Bitte prüfen Sie unter > "Einstellungen" > "Systemsteuerung" > "Netzwerkeinstellungen", ob die Netzwerk-Einstellungen nach folgendem Schema eingetragen sind. Wichtig ist, dass die ersten <span style="color: #0B7000">drei Segmente</span> der IP-Adresse, des Gateways und des DNS-Servers identisch sind. Zudem entspricht die IP-Adresse des Gateways und des Bevorzugten DNS-Servers in der Regel der Router IP-Adresse.<br>
<br>
Beispiel (bei Verwendung einer Fritz!Box):<br>
<table width="450" border="0">
  <tbody>
    <tr>
      <td width="146" bgcolor="#BCBCBC">IP-Adresse:</td>
      <td width="120" bgcolor="#BCBCBC" style="text-align: center"><span style="color: #0B7000; font-weight: bold;">192.168.178</span>.xxx</td>
      <td width="170" bgcolor="#BCBCBC">(xxx steht für eine beliebige freie Adresse)</td>
    </tr>
    <tr>
      <td>Subnetmaske:</td>
      <td style="text-align: center">255.255.255.0</td>
      <td>&nbsp;</td>
    </tr>
    <tr>
      <td bgcolor="#BCBCBC">Gateway:</td>
      <td bgcolor="#BCBCBC" style="text-align: center"><span style="font-weight: bold; color: #0B7000;">192.168.178</span>.1</td>
      <td bgcolor="#BCBCBC">(IP-Adresse des Routers)</td>
    </tr>
    <tr>
      <td>Bevorzugter DNS-Server:</td>
      <td style="text-align: center"><span style="color: #0B7000; font-weight: bold;">192.168.178</span>.1</td>
      <td>(IP-Adresse des Routers)</td>
    </tr>
    <tr>
      <td bgcolor="#BCBCBC">Alternativer DNS-Server:</td>
      <td bgcolor="#BCBCBC" style="text-align: center">0.0.0.0</td>
      <td bgcolor="#BCBCBC">&nbsp;</td>
    </tr>
  </tbody>
</table>
<br>
Mit dem folgenden Skript kann zusätzlich über die WebUI unter > "Programme & Zentralenverknüpfung" > "Skript testen", geprüft werden, ob die CCU mit der Außenwelt kommunizieren kann.<br><br>
<span style="color: #34A028"><em>string stderr;<br>
string stdout;<br>
integer Auslese;<br>
system.Exec("ping -c 1 www.google.de",&stdout, &stderr);<br>
Auslese = stdout.Find("ms");<br>
if ( Auslese == -1 )<br>
{<br>
WriteLine("CCU ist NICHT mit der Welt verbunden");<br>
}<br>
if ( Auslese > 0)<br>
{<br>
WriteLine('CCU ist mit der Welt verbunden, und der DNS funktioniert');<br>
}</em></span><br><br>
Sofern das Skript ausgibt, das die CCU ist NICHT mit der Welt verbunden ist, sollten folgende Punkte geprüft werden.<br>
<br>
1. Internetverbindung okay?<br>
2. Netzwerkkabel okay?<br>
3. Bei der Fritz!Box für den LAN-Port an dem die CCU hängt von GreenMode auf PowerMode umstellen (<a href="http://avm.de/nc/service/fritzbox/fritzbox-7390/wissensdatenbank/publication/show/318_LAN-Verbindung-zur-FRITZ-Box-nicht-moeglich/" target="_blank">7 Energieeinstellungen der FRITZ!Box anpassen</a>).<br>
4. Der CCU nach dem obengenannten Schema eine Feste-IP zuweisen.<br>
5. Für das vierte  Segment der CCU IP-Adresse eine zweistellige und freie Adresse vergeben (z.B. 192.168.x.22).<br>
<br>

<a href="#top">^ nach oben ^</a><br>
</body>
</html>
